import sys
import time
from os.path import abspath, join, dirname
sys.path.insert(0, join(abspath(dirname(__file__)), '../../'))
# sys.stdout = io.TextIOWrapper(sys.stdout.buffer,encoding='utf8')

import models.plugins.batch as Batch
import application as app

class main(Batch.main):
    def brush_bak0122(self, smonth, emonth):
        sql = 'SELECT source, tb_item_id, real_p1 FROM {}'.format(self.cleaner.get_tbl())
        ret = self.cleaner.db26.query_all(sql)
        mpp = {'{}-{}-{}'.format(v[0],v[1],v[2]):True for v in ret}

        xxx = self.xxx()
        tb_item_ids = ['\'{}\''.format(v[0]) for v in xxx]
        uuids = []

        sql = '''
            SELECT argMax(uuid2, month), source, tb_item_id, p1 FROM {}_parts
            WHERE tb_item_id IN ({})
            GROUP BY source, tb_item_id, p1
        '''.format(self.get_entity_tbl(), ','.join(tb_item_ids))
        ret = self.cleaner.dbch.query_all(sql)
        for uuid2, source, tb_item_id, p1, in ret:
            if '{}-{}-{}'.format(source, tb_item_id, p1) in mpp:
                continue
            uuids.append(uuid2)
        clean_flag = self.cleaner.last_clean_flag() + 1
        # self.cleaner.add_brush(uuids, clean_flag, 1)
        print(xxx)
        for tb_item_id, sp1, in xxx:
            sql = 'UPDATE {} SET spid1 = \'{}\', flag=1, uid=227 WHERE tb_item_id = {}'.format(self.cleaner.get_tbl(), sp1, tb_item_id)
            print(sql)
            self.cleaner.db26.execute(sql)
        print('add new brush {}'.format(len(uuids)))
        return True


    def brush(self, smonth, emonth):
        uuids = []
        ret, sales_by_uuid = self.cleaner.process_top_anew(smonth, emonth, limit=100)
        for uuid2, source, tb_item_id, p1, cid in ret:
            if self.skip_brush(source, tb_item_id, p1):
                continue
            uuids.append(uuid2)
        uuids2 = []
        ret2, sales_by_uuid2 = self.cleaner.process_top_anew(smonth, emonth, orderBy='rand()', limit=100)
        for uuid2, source, tb_item_id, p1, cid in ret2:
            if self.skip_brush(source, tb_item_id, p1):
                continue
            uuids2.append(uuid2)
        clean_flag = self.cleaner.last_clean_flag() + 1
        self.cleaner.add_brush(uuids, clean_flag, 1, sales_by_uuid=sales_by_uuid)
        self.cleaner.add_brush(uuids2, clean_flag, 2)
        return True

    def xxx(self):
        return [
                [540159475105, '大盘卷纸'],
                [595314184897, '大盘卷纸'],
                [45101691036, '大盘卷纸'],
                [557418976713, '大盘卷纸'],
                [564135111481, '大盘卷纸'],
                [619600995183, '大盘卷纸'],
                [559686121121, '大盘卷纸'],
                [552771701514, '大盘卷纸'],
                [557605317448, '大盘卷纸'],
                [537685608337, '大盘卷纸'],
                [537484815768, '大盘卷纸'],
                [536457988886, '大盘卷纸'],
                [541860131779, '大盘卷纸'],
                [579636793331, '大盘卷纸'],
                [44902350298, '大盘卷纸'],
                [605111033569, '大盘卷纸'],
                [36322544717, '大盘卷纸'],
                [539813560552, '大盘卷纸'],
                [43868886734, '大盘卷纸'],
                [593739564961, '大盘卷纸'],
                [609720425261, '大盘卷纸'],
                [565228263709, '大盘卷纸'],
                [546317818582, '大盘卷纸'],
                [620798065717, '大盘卷纸'],
                [607216646256, '大盘卷纸'],
                [604372514126, '大盘卷纸'],
                [550552801322, '大盘卷纸'],
                [596576257616, '大盘卷纸'],
                [618994729159, '大盘卷纸'],
                [530581160169, '大盘卷纸'],
                [527996294340, '大盘卷纸'],
                [591441673303, '大盘卷纸'],
                [543154820241, '大盘卷纸'],
                [557481142823, '大盘卷纸'],
                [40590883766, '大盘卷纸'],
                [608666076778, '大盘卷纸'],
                [602089463114, '大盘卷纸'],
                [609665082582, '大盘卷纸'],
                [536151462565, '大盘卷纸'],
                [557988085965, '大盘卷纸'],
                [43820013767, '大盘卷纸'],
                [572809398204, '大盘卷纸'],
                [609695386760, '大盘卷纸'],
                [43594087025, '大盘卷纸'],
                [556511009260, '大盘卷纸'],
                [565750239634, '大盘卷纸'],
                [42342250306, '大盘卷纸'],
                [543289923763, '大盘卷纸'],
                [591221388788, '大盘卷纸'],
                [550800626111, '大盘卷纸'],
                [554833435256, '大盘卷纸'],
                [599977165399, '大盘卷纸'],
                [36313681235, '大盘卷纸'],
                [557976448239, '大盘卷纸'],
                [587919599281, '大盘卷纸'],
                [559965472731, '大盘卷纸'],
                [543548207327, '大盘卷纸'],
                [523760087850, '大盘卷纸'],
                [44281754368, '大盘卷纸'],
                [556875041501, '大盘卷纸'],
                [590205326870, '大盘卷纸'],
                [605380801265, '大盘卷纸'],
                [565156203050, '大盘卷纸'],
                [565590173426, '大盘卷纸'],
                [39344277991, '大盘卷纸'],
                [557986761703, '大盘卷纸'],
                [603047411397, '大盘卷纸'],
                [584374285253, '大盘卷纸'],
                [599479125960, '大盘卷纸'],
                [618776748422, '其他'],
                [601274857768, '大盘卷纸'],
                [590428155416, '大盘卷纸'],
                [584597296835, '大盘卷纸'],
                [522860383889, '大盘卷纸'],
                [615397365598, '大盘卷纸'],
                [609401210120, '大盘卷纸'],
                [544723397889, '大盘卷纸'],
                [529289223794, '大盘卷纸'],
                [538824213713, '大盘卷纸'],
                [569060984826, '大盘卷纸'],
                [615034139437, '大盘卷纸'],
                [584454939309, '大盘卷纸'],
                [612600838777, '大盘卷纸'],
                [608895260515, '大盘卷纸'],
                [592891623854, '大盘卷纸'],
                [618182416348, '大盘卷纸'],
                [552357447902, '大盘卷纸'],
                [555915605142, '大盘卷纸'],
                [591543229663, '大盘卷纸'],
                [544371477444, '大盘卷纸'],
                [620382065859, '大盘卷纸'],
                [520385106946, '大盘卷纸'],
                [579627904918, '大盘卷纸'],
                [527932908244, '大盘卷纸'],
                [606900291782, '大盘卷纸'],
                [528429733722, '大盘卷纸'],
                [564998913805, '大盘卷纸'],
                [527244780625, '大盘卷纸'],
                [544548157589, '大盘卷纸'],
                [602135974543, '大盘卷纸'],
                [563834177641, '擦手纸'],
                [620696737190, '其他'],
                [38186817542, '擦手纸'],
                [563835009431, '擦手纸'],
                [540158830042, '擦手纸'],
                [583502327460, '擦手纸'],
                [557520308539, '擦手纸'],
                [44423388456, '擦手纸'],
                [565677606687, '擦手纸'],
                [606984621151, '擦手纸'],
                [597649902797, '擦手纸'],
                [585700683798, '擦手纸'],
                [573061058503, '擦手纸'],
                [619802949067, '擦手纸'],
                [555443912202, '擦手纸'],
                [617717799691, '擦手纸'],
                [588545603244, '擦手纸'],
                [620541620794, '其他'],
                [42386872986, '擦手纸'],
                [556905033229, '擦手纸'],
                [597654813990, '擦手纸'],
                [39332594164, '擦手纸'],
                [536504216572, '擦手纸'],
                [592605245607, '擦手纸'],
                [618669900504, '擦手纸'],
                [622929003458, '其他'],
                [45880448023, '擦手纸'],
                [566714114356, '擦手纸'],
                [12600571423, '擦手纸'],
                [35465189957, '擦手纸'],
                [552939319392, '擦手纸'],
                [591221928329, '擦手纸'],
                [582667858340, '擦手纸'],
                [536263897558, '擦手纸'],
                [583629998913, '擦手纸'],
                [604430003437, '其他'],
                [43667928264, '擦手纸'],
                [588389626570, '擦手纸'],
                [556422305207, '擦手纸'],
                [563807559777, '擦手纸'],
                [555735828853, '擦手纸'],
                [623094637733, '其他'],
                [578311784963, '擦手纸'],
                [600074479028, '擦手纸'],
                [593335783913, '擦手纸'],
                [521214487223, '擦手纸'],
                [543485601649, '擦手纸'],
                [44861206619, '擦手纸'],
                [527309961842, '擦手纸'],
                [540264588055, '擦手纸'],
                [549169258992, '擦手纸'],
                [619804531401, '擦手纸'],
                [595096980332, '擦手纸'],
                [527148877484, '擦手纸'],
                [622268108648, '其他'],
                [604522291169, '擦手纸'],
                [555542298364, '擦手纸'],
                [619812778013, '其他'],
                [619534793382, '擦手纸'],
                [571083856995, '擦手纸'],
                [557628533018, '擦手纸'],
                [593917202970, '擦手纸'],
                [548495335656, '擦手纸'],
                [530202888421, '擦手纸'],
                [523747758582, '擦手纸'],
                [534015703434, '擦手纸'],
                [594201504401, '擦手纸'],
                [582725135358, '擦手纸'],
                [543485189730, '擦手纸'],
                [572403616809, '擦手纸'],
                [620017559383, '擦手纸'],
                [617912727955, '擦手纸'],
                [597747456709, '擦手纸'],
                [590556547951, '擦手纸'],
                [556009514009, '擦手纸'],
                [568825427527, '擦手纸'],
                [605526923385, '擦手纸'],
                [604527715554, '擦手纸'],
                [610896909201, '擦手纸'],
                [543179017865, '擦手纸'],
                [618182376942, '其他'],
                [571343952003, '擦手纸'],
                [596332450455, '擦手纸'],
                [564428377014, '擦手纸'],
                [570430204302, '擦手纸'],
                [564728444073, '擦手纸'],
                [600473718606, '擦手纸'],
                [568335005803, '擦手纸'],
                [616098280712, '擦手纸'],
                [561256232905, '擦手纸'],
                [613618995399, '擦手纸'],
                [571158326613, '擦手纸'],
                [607677379245, '擦手纸'],
                [614787442749, '擦手纸'],
                [584433158809, '擦手纸'],
                [40229519253, '擦手纸'],
                [612701833139, '擦手纸'],
                [564998865561, '擦手纸'],
                [611131405742, '擦手纸'],
                [596036987662, '擦手纸'],
                [526213895114, '酒店商用纸'],
                [599352746144, '酒店商用纸'],
                [604845956258, '酒店商用纸'],
                [619596585977, '酒店商用纸'],
                [619965106756, '酒店商用纸'],
                [558191533921, '酒店商用纸'],
                [621177071839, '其他'],
                [562635340027, '酒店商用纸'],
                [556005483324, '酒店商用纸'],
                [595860731708, '酒店商用纸'],
                [567131630205, '酒店商用纸'],
                [578160659491, '酒店商用纸'],
                [613251356750, '酒店商用纸'],
                [617527947848, '酒店商用纸'],
                [45864533453, '酒店商用纸'],
                [564997596607, '酒店商用纸'],
                [617826861548, '擦手纸'],
                [620921774208, '其他'],
                [536582435888, '酒店商用纸'],
                [607732406783, '酒店商用纸'],
                [619606842568, '酒店商用纸'],
                [561257900174, '酒店商用纸'],
                [562054371135, '酒店商用纸'],
                [615053979824, '酒店商用纸'],
                [624017987494, '擦手纸'],
                [593809413272, '酒店商用纸'],
                [593837118490, '酒店商用纸'],
                [610628449648, '酒店商用纸'],
                [618720576412, '酒店商用纸'],
                [601577136203, '酒店商用纸'],
                [577657156070, '酒店商用纸'],
                [579185671589, '酒店商用纸'],
                [568363270828, '酒店商用纸'],
                [40732946691, '酒店商用纸'],
                [560970854771, '酒店商用纸'],
                [565185206388, '酒店商用纸'],
                [620841993201, '其他'],
                [613975993155, '酒店商用纸'],
                [598576359843, '酒店商用纸'],
                [558396460149, '酒店商用纸'],
                [572083283869, '酒店商用纸'],
                [609653061904, '酒店商用纸'],
                [600344707320, '酒店商用纸'],
                [622178225449, '酒店商用纸'],
                [623306486855, '其他'],
                [618388338581, '其他'],
                [600247136951, '酒店商用纸'],
                [567053909291, '酒店商用纸'],
                [600278531915, '酒店商用纸'],
                [557605894593, '酒店商用纸'],
                [575821889546, '酒店商用纸'],
                [527187048369, '酒店商用纸'],
                [622069461348, '酒店商用纸'],
                [621040352119, '擦手纸'],
                [616000119167, '酒店商用纸'],
                [623146511251, '其他'],
                [523743892466, '酒店商用纸'],
                [546006511602, '酒店商用纸'],
                [622347699968, '酒店商用纸'],
                [554602402538, '酒店商用纸'],
                [603006690891, '酒店商用纸'],
                [557926450617, '酒店商用纸'],
                [594906385810, '酒店商用纸'],
                [600993663843, '酒店商用纸'],
                [590133131687, '酒店商用纸'],
                [598634979331, '酒店商用纸'],
                [596485124237, '大盘卷纸'],
                [588565753459, '酒店商用纸'],
                [620206367530, '其他'],
                [45890396147, '酒店商用纸'],
                [623055912518, '酒店商用纸'],
                [600730175082, '酒店商用纸'],
                [561984134320, '酒店商用纸'],
                [600407882835, '酒店商用纸'],
                [618186408182, '其他'],
                [43632245926, '酒店商用纸'],
                [590302900197, '酒店商用纸'],
                [555778175677, '酒店商用纸'],
                [558754015221, '酒店商用纸'],
                [594136173474, '酒店商用纸'],
                [574655259249, '酒店商用纸'],
                [617531657049, '其他'],
                [586679148300, '酒店商用纸'],
                [584859278838, '酒店商用纸'],
                [618638179884, '其他'],
                [595896731033, '酒店商用纸'],
                [567219471723, '酒店商用纸'],
                [595689330159, '酒店商用纸'],
                [585000187648, '酒店商用纸'],
                [600549410462, '酒店商用纸'],
                [588083642236, '酒店商用纸'],
                [609678816183, '酒店商用纸'],
                [620199971984, '其他'],
                [541523128725, '酒店商用纸'],
                [590132367944, '酒店商用纸'],
                [616376791737, '酒店商用纸'],
                [527175580108, '酒店商用纸'],
                [601209999232, '酒店商用纸'],
                [574442754620, '擦手纸'],
                [42131434254, '酒店商用纸'],
                [595314184897, '大盘卷纸'],
                [45101691036, '大盘卷纸'],
                [564135111481, '大盘卷纸'],
                [559686121121, '大盘卷纸'],
                [536457988886, '大盘卷纸'],
                [537685608337, '大盘卷纸'],
                [539813560552, '大盘卷纸'],
                [612351898980, '大盘卷纸'],
                [543548207327, '大盘卷纸'],
                [552965301186, '大盘卷纸'],
                [565156203050, '大盘卷纸'],
                [44281754368, '大盘卷纸'],
                [608895260515, '大盘卷纸'],
                [555915605142, '大盘卷纸'],
                [608839940664, '大盘卷纸'],
                [592891623854, '大盘卷纸'],
                [544770574661, '大盘卷纸'],
                [563730038964, '大盘卷纸'],
                [614822275394, '大盘卷纸'],
                [597724750770, '大盘卷纸'],
                [602903306575, '大盘卷纸'],
                [542712025588, '大盘卷纸'],
                [572905539914, '大盘卷纸'],
                [40836951837, '大盘卷纸'],
                [540362598029, '大盘卷纸'],
                [44205818109, '大盘卷纸'],
                [563834177641, '擦手纸'],
                [563835009431, '擦手纸'],
                [552939319392, '擦手纸'],
                [572698033408, '擦手纸'],
                [584112904521, '擦手纸'],
                [540730605388, '擦手纸'],
                [614144554623, '擦手纸'],
                [570959582433, '擦手纸'],
                [604900020751, '擦手纸'],
                [609512455742, '擦手纸'],
                [552768248280, '擦手纸'],
                [592673918568, '擦手纸'],
                [600350193919, '擦手纸'],
                [594970230598, '擦手纸'],
                [611490976865, '擦手纸'],
                [587559451595, '擦手纸'],
                [552786504947, '擦手纸'],
                [585557002034, '擦手纸'],
                [559108951680, '擦手纸'],
                [611140327744, '擦手纸'],
                [569389640687, '擦手纸'],
                [587530946316, '擦手纸'],
                [45870073461, '擦手纸'],
                [599352746144, '酒店商用纸'],
                [558191533921, '酒店商用纸'],
                [619596585977, '酒店商用纸'],
                [562635340027, '酒店商用纸'],
                [617437260434, '酒店商用纸'],
                [614371911899, '酒店商用纸'],
                [610082936848, '酒店商用纸'],
                [593809413272, '酒店商用纸'],
                [572083283869, '酒店商用纸'],
                [616448652547, '酒店商用纸'],
                [535318303692, '酒店商用纸'],
                [593584016163, '酒店商用纸'],
                [617826861548, '擦手纸'],
                [594006643842, '酒店商用纸'],
                [574248128189, '酒店商用纸'],
                [615930583420, '酒店商用纸'],
                [598425232907, '酒店商用纸'],
                [558578922613, '酒店商用纸'],
                [606076467967, '酒店商用纸'],
                [615187154674, '酒店商用纸'],
                [593290851642, '酒店商用纸'],
                [601708681457, '酒店商用纸'],
                [609653061904, '酒店商用纸'],
                [555778175677, '酒店商用纸'],
                [523967134327, '酒店商用纸'],
                [560108369770, '酒店商用纸'],
                [546078007389, '酒店商用纸'],
                [552891698036, '酒店商用纸'],
                [561342739072, '酒店商用纸'],
                [543943823422, '酒店商用纸'],
                [38228609407, '酒店商用纸'],
                [547219524803, '酒店商用纸'],
                [598582171648, '酒店商用纸'],
                [617833118441, '酒店商用纸'],
                [555905083889, '酒店商用纸'],
               ]